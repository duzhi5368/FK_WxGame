function addBaseNode(){null==baseNode&&(baseNode=new Laya.Sprite,Laya.stage.addChild(baseNode))}function login(){null==userInfo&&wx.getUserInfo({openIdList:["selfOpenId"],lang:"zh_CN",success:function(e){console.log("success",e.data),userInfo=e.data[0]},fail:function(e){console.log("fail",e.data)}})}function removeAllScore(){wx.removeUserCloudStorage({keyList:["score_"+Utils.getWeekNum()],success:function(e){console.log("removeAllScore success",e.data)},fail:function(e){console.log("removeAllScore fail",e.data)}})}function updateScore(e){wx.getUserCloudStorage({keyList:["score_"+Utils.getWeekNum()],fail:function(e){console.log(e)},success:function(a){var t=!1;if(0==a.KVDataList.length)t=!0,wx.removeUserCloudStorage({keyList:["score_"+(Utils.getWeekNum()-1)],success:function(e){console.log(e)},fail:function(e){console.log(e)}});else{var s=parseInt(a.KVDataList[0].value,10);e.score>=s&&(t=!0)}var r=parseInt((new Date).getTime()/1e3),n=JSON.stringify({wxgame:{score:e.score,update_time:r}});t?wx.setUserCloudStorage({KVDataList:[{key:"score_"+Utils.getWeekNum(),value:e.score.toString()},{key:"gameRank",value:n}],success:function(e){console.log("update user score success"),showEndFriends(null)},fail:function(e){console.log("update user score fail")}}):showEndFriends(null)}})}function showEndFriends(e){console.log("showEndFriends"),wx.getFriendCloudStorage({keyList:["score_"+Utils.getWeekNum()],fail:function(e){console.log(e)},success:function(e){e.data=Utils.getValidData(e.data),e.data=Utils.scoreOrder(e.data);for(s=0;s<e.data.length;s++){if(e.data[s].nickname==userInfo.nickName){var a=new Array;if(0==s)for(t=0;t<3;t++){r=0;0==t?(r=s,a.push(r)):s+t<e.data.length&&(r=s+t,a.push(r))}else for(var t=0;t<3;t++){r=0;0==t&&s-1>=0&&(!0,r=s-1,a.push(r)),1==t&&(r=s,a.push(r)),2==t&&s+1<e.data.length&&(r=s+1,a.push(r))}for(var s=0;s<a.length;s++){var r=a[s],n=e.data[r];if(r<=2){(i=writeImage("game/img_di"+(r+1)+".png",-180,0+-80*(1-s),60,60)).anchorY=.5,Laya.stage.addChild(i)}else{var o=writeText((r+1).toString(),-180,0+-80*(1-s),260,600+90*s,120,30,30,"white","center");o.anchorY=.5,Laya.stage.addChild(o)}var i=writeImage(e.data[r].avatarUrl,-100,0+-80*(1-s),60,60);i.anchorY=.5,Laya.stage.addChild(i);var l=writeText(Utils.labelTransform(n.nickname,36,250),0,0+-80*(1-s),260,600+90*s,120,30,30,"white","center");l.anchorY=.5,Laya.stage.addChild(l);var c=writeText(n.KVDataList[0].value,180,0+-80*(1-s),410,600+90*s,120,30,30,"#FFFFFF","left");c.anchorY=.5,Laya.stage.addChild(c)}break}}}})}function showFriendAvatar(e){wx.getFriendCloudStorage({keyList:["score_"+Utils.getWeekNum()],success:function(e){console.log(e.KVDataList),e.data=Utils.getValidData(e.data),e.data=Utils.scoreOrder(e.data);for(var a=0;a<e.data.length;a++){if(e.data[a].nickname==userInfo.nickName){if(0==a)console.log("你已经是最高名次");else{s=writeText("下一个即将超越好友：",100,1138,120,30,24,"white","center");Laya.stage.addChild(s);var t=writeImage(e.data[a-1].avatarUrl,402,1125,80,80);Laya.stage.addChild(t);var s=writeText(e.data[a-1].KVDataList[0].value,502,1138,120,50,40,"white","center");Laya.stage.addChild(s)}break}}}})}function showRank(e){wx.getFriendCloudStorage({keyList:["score_"+Utils.getWeekNum()],fail:function(e){console.log(e)},success:function(e){console.log("getFriendCloudStorage");var a=Utils.getValidData(e.data);a=Utils.scoreOrder(a);var t=new Laya.List;t.itemRender=RankItem,t.vScrollBarSkin="",t.repeatX=1,t.repeatY=5,t.array=a,t.centerX=0,t.centerY=0,t.size(577,636),t.renderHandler=new Laya.Handler(this,updateItem),Laya.stage.addChild(t)}})}function updateItem(e,a){e.init(e,a)}function writeImage(e,a,t,s,r){var n=new Laya.Image(e);return n.centerX=a,n.centerY=t,n.size(s,r),n}function writeText(e,a,t,s,r,n,o,i,l,c){var d=new Laya.Label;return d.text=e,d.width=n,d.height=o,d.valign="middle",d.fontSize=i,d.color=l,d.align=c,d.font="SimHei",d.bold=!1,d.x=s,d.y=r,d.centerX=a,d.centerY=t,d}function testData(e,a){for(var t=0;t<e;t++){var s={nickname:"zhou"+t,avatarUrl:"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoibM43W…T3LIAvEzibQO7FQsuibRVhmzoouePibWhfhicco11V0YQ/132",KVDataList:[{value:100+t}]};a.push(s)}return a}require("./weapp-adapter.js"),require("./libs/laya.core.js"),require("./libs/laya.wxmini.js"),require("./libs/laya.webgl.js"),require("./libs/laya.ani.js"),require("./libs/laya.ui.js"),require("./RankItem.js");var baseNode=null,userInfo=null;Laya.MiniAdpter.init(!0,!0),Laya.init(720,1280),Laya.stage.scaleMode="fixedauto",Laya.stage.screenMode="vertical",Laya.stage.alignH="center",Laya.stage.alignV="middle",Laya.stage.bgColor="#191514",login(),wx.onMessage(function(e){switch(login(),Laya.stage.removeChildren(),e.act){case"wxInit":console.log("-----------------sharedresize----------1------------------"),console.log(e.data.matrix),console.log("-----------------sharedresize------------2----------------"),e.data.matrix&&console.log(Laya.stage._canvasTransform);break;case"updateScore":updateScore(e);break;case"showRank":showRank(e);break;case"showFriendAvatar":showFriendAvatar(e);break;case"showEndFriends":showEndFriends(e);break;case"clearChildren":Laya.stage.removeChildren()}});